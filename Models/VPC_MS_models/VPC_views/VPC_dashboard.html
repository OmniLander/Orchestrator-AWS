<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cloud Infrastructure Monitor</title>

    <!-- Bootstrap & Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />

    <style>
      body {
        background-color: #f8f9fa;
      }
      .card {
        border: none;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
      }
      .card:hover {
        transform: translateY(-5px);
      }
      .status-badge {
        font-size: 0.8em;
        padding: 5px 10px;
        border-radius: 12px;
      }
      .bg-gradient-primary {
        background: linear-gradient(45deg, #4e73df, #224abe);
        color: white;
      }
      .refresh-btn {
        cursor: pointer;
        transition: transform 0.5s;
      }
      .refresh-btn:hover {
        transform: rotate(180deg);
      }

      /* Modo explicado */
      .explain-on [data-explain]::after {
        content: attr(data-explain);
        display: block;
        color: #2d2d2d;
        font-size: 0.85em;
        margin-top: 6px;
        padding: 6px;
        background: #eef3ff;
        border-left: 4px solid #3f66ff;
        border-radius: 6px;
      }
    </style>
  </head>
  <body>
    <!-- NAV -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
      <div class="container-fluid">
        <a class="navbar-brand" href="#"
          ><i class="fas fa-network-wired me-2"></i>VPC Master Control</a
        >

        <button
          class="btn btn-outline-light btn-sm me-3"
          onclick="fetchAllData()"
        >
          <i class="fas fa-sync-alt refresh-btn"></i> Refresh
        </button>

        <!-- Modo explicado -->
        <div class="form-check form-switch text-white">
          <input
            class="form-check-input"
            type="checkbox"
            id="explainMode"
            onchange="toggleExplainMode()"
          />
          <label class="form-check-label" for="explainMode"
            >Modo explicado</label
          >
        </div>
      </div>
    </nav>

    <div class="container">
      <!-- DASHBOARD CARDS -->
      <div class="row mb-4">
        <div class="col-md-4">
          <div
            class="card bg-gradient-primary"
            data-bs-toggle="tooltip"
            title="Cantidad total de VPC detectadas en tu infraestructura AWS."
          >
            <div class="card-body">
              <h5 class="card-title">Active VPCs</h5>
              <h2 class="display-6" id="vpc-count">0</h2>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div
            class="card bg-success text-white"
            data-bs-toggle="tooltip"
            title="Total de subnets clasificadas por su VPC correspondiente."
          >
            <div class="card-body">
              <h5 class="card-title">Active Subnets</h5>
              <h2 class="display-6" id="subnet-count">0</h2>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div
            class="card bg-info text-white"
            data-bs-toggle="tooltip"
            title="Cantidad de ACLs que están asociadas a tus VPC y subnets."
          >
            <div class="card-body">
              <h5 class="card-title">Network ACLs</h5>
              <h2 class="display-6" id="acl-count">0</h2>
            </div>
          </div>
        </div>
      </div>

      <!-- VPC TABLE -->
      <div
        class="card mb-4"
        data-explain="Las VPC son redes virtuales donde se alojan tus recursos AWS: EC2, RDS, Load Balancers, etc. Aquí puedes visualizar su estado y eliminarlas si no tienen dependencias."
      >
        <div
          class="card-header bg-white d-flex justify-content-between align-items-center"
        >
          <h5 class="mb-0">VPC Inventory</h5>
          <div class="d-flex align-items-center">
            <!-- Filtro rápido VPC -->
            <div class="input-group input-group-sm me-2">
              <span class="input-group-text">
                <i class="fas fa-search"></i>
              </span>
              <input
                type="text"
                class="form-control"
                id="filter-vpc"
                placeholder="Filtrar por nombre o VPC ID"
              />
            </div>

            <button
              class="btn btn-primary btn-sm me-2"
              data-bs-toggle="modal"
              data-bs-target="#createVPCModal"
            >
              <i class="fas fa-plus"></i> New VPC
            </button>
            <button
              class="btn btn-outline-info btn-sm"
              onclick="openHelp('vpc')"
            >
              <i class="fas fa-question-circle"></i>
            </button>
          </div>
        </div>

        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th>Name</th>
                  <th>VPC ID</th>
                  <th>CIDR Block</th>
                  <th>State</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="vpc-table-body"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- SUBNET TABLE -->
      <div
        class="card mb-4"
        data-explain="Las Subnets dividen tu VPC en zonas. Pueden ser públicas o privadas."
      >
        <div
          class="card-header bg-white d-flex justify-content-between align-items-center"
        >
          <h5 class="mb-0">Subnet Distribution</h5>
          <div class="d-flex align-items-center">
            <!-- Filtro rápido Subnets -->
            <div class="input-group input-group-sm me-2">
              <span class="input-group-text">
                <i class="fas fa-search"></i>
              </span>
              <input
                type="text"
                class="form-control"
                id="filter-subnet"
                placeholder="Filtrar por VPC, nombre o zona"
              />
            </div>

            <button
              class="btn btn-primary btn-sm me-2"
              data-bs-toggle="modal"
              data-bs-target="#createSubnetModal"
            >
              <i class="fas fa-plus"></i> New Subnet
            </button>
            <button
              class="btn btn-outline-info btn-sm"
              onclick="openHelp('subnet')"
            >
              <i class="fas fa-question-circle"></i>
            </button>
          </div>
        </div>

        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-sm table-bordered">
              <thead class="table-light">
                <tr>
                  <th>VPC ID</th>
                  <th>Subnet Name</th>
                  <th>Subnet ID</th>
                  <th>Zone</th>
                  <th>CIDR</th>
                  <th>State</th>
                </tr>
              </thead>
              <tbody id="subnet-table-body"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ACL TABLE -->
      <div
        class="card mb-4"
        data-explain="Las ACLs son firewalls que controlan el tráfico de entrada y salida hacia las subnets."
      >
        <div
          class="card-header bg-white d-flex justify-content-between align-items-center"
        >
          <h5 class="mb-0">
            <i class="fas fa-shield-alt me-2"></i> Network ACLs
          </h5>
          <div class="d-flex align-items-center">
            <!-- Filtro rápido ACL -->
            <div class="input-group input-group-sm me-2">
              <span class="input-group-text">
                <i class="fas fa-search"></i>
              </span>
              <input
                type="text"
                class="form-control"
                id="filter-acl"
                placeholder="Filtrar por nombre, ID o VPC"
              />
            </div>

            <button
              class="btn btn-primary btn-sm me-2"
              data-bs-toggle="modal"
              data-bs-target="#createACLModal"
            >
              <i class="fas fa-plus"></i> New ACL
            </button>
            <button
              class="btn btn-outline-info btn-sm"
              onclick="openHelp('acl')"
            >
              <i class="fas fa-question-circle"></i>
            </button>
          </div>
        </div>

        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th>ACL Name</th>
                  <th>ACL ID</th>
                  <th>VPC Asignada</th>
                  <th>Reglas (In/Out)</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="acl-table-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- HELP MODAL -->
    <div class="modal fade" id="helpModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-info text-white">
            <h5 class="modal-title">Guía rápida</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body" id="helpContent"></div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- MODAL CREAR VPC -->
    <div class="modal fade" id="createVPCModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Create New VPC</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="form-create-vpc" autocomplete="off">
              <div class="mb-3">
                <label class="form-label">VPC Name</label>
                <input
                  type="text"
                  class="form-control"
                  id="new-vpc-name"
                  placeholder="My-VPC-01"
                  required
                />
                <div class="form-text">
                  Un alias legible para que el equipo identifique rápidamente la
                  VPC.
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">CIDR Block</label>
                <input
                  type="text"
                  class="form-control"
                  id="new-vpc-cidr"
                  placeholder="10.0.0.0/16"
                  required
                />
                <div class="form-text">
                  Rango IP privado (ej. 10.0.0.0/16). Se validará que sea un
                  bloque válido.
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="createVPC()"
            >
              Create VPC
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL CREAR SUBNET -->
    <div class="modal fade" id="createSubnetModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Create New Subnet</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="form-create-subnet" autocomplete="off">
              <div class="mb-3">
                <label class="form-label">Target VPC ID</label>
                <input
                  list="vpc-id-datalist"
                  type="text"
                  class="form-control"
                  id="new-subnet-vpcid"
                  placeholder="vpc-xxxxxxxxxxxxxxxxx"
                  required
                />
                <datalist id="vpc-id-datalist">
                  <!-- JS rellenará dinámicamente con VPC IDs detectados -->
                </datalist>
                <div class="form-text">
                  Empieza a escribir y selecciona una VPC válida detectada en tu
                  cuenta.
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Subnet Name</label>
                <input
                  type="text"
                  class="form-control"
                  id="new-subnet-name"
                  placeholder="Public-Subnet-1"
                />
                <div class="form-text">
                  Nombre descriptivo (ej. Public-Subnet-AZ1).
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">CIDR Block</label>
                <input
                  type="text"
                  class="form-control"
                  id="new-subnet-cidr"
                  placeholder="10.0.1.0/24"
                  required
                />
                <div class="form-text">
                  El rango debe estar contenido dentro del CIDR de la VPC.
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="createSubnet()"
            >
              Create Subnet
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL CREAR ACL -->
    <div class="modal fade" id="createACLModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Create Network ACL</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="form-create-acl" autocomplete="off">
              <div class="mb-3">
                <label class="form-label">VPC ID</label>
                <input
                  list="vpc-id-datalist-acl"
                  type="text"
                  class="form-control"
                  id="new-acl-vpcid"
                  placeholder="vpc-xxxxxxxxxxxxxxxxx"
                  required
                />
                <datalist id="vpc-id-datalist-acl">
                  <!-- JS rellenará dinámicamente con VPC IDs detectados -->
                </datalist>
                <div class="form-text">
                  Selecciona la VPC donde estará asociada esta ACL.
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">ACL Name</label>
                <input
                  type="text"
                  class="form-control"
                  id="new-acl-name"
                  placeholder="My-Firewall-Rules"
                />
                <div class="form-text">
                  Un nombre descriptivo de las reglas que manejará esta ACL.
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="createACL()"
            >
              Create ACL
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      /* Tooltip Loader */
      document.addEventListener("DOMContentLoaded", function () {
        [...document.querySelectorAll('[data-bs-toggle="tooltip"]')].forEach(
          (el) => new bootstrap.Tooltip(el)
        );
      });

      /* Modo explicado */
      function toggleExplainMode() {
        document.body.classList.toggle("explain-on");
      }

      /* Ayuda Popup */
      function openHelp(section) {
        const helpText = {
          vpc: `
            <b>¿Qué es una VPC?</b><br>
            Es una red virtual donde se alojan recursos como EC2, RDS y Load Balancers.<br><br>
            <b>Avisos:</b>
            <ul>
                <li>No elimines una VPC sin revisar subnets.</li>
                <li>Revisa el CIDR para evitar traslapes.</li>
            </ul>
        `,
          subnet: `
            <b>¿Qué es una Subnet?</b><br>
            Es una sección de tu VPC. Puede ser pública o privada.<br><br>
            <b>Recomendaciones:</b>
            <ul>
                <li>Usa públicas solo para cargas que lo requieran.</li>
                <li>No mezcles recursos sensibles en subnets públicas.</li>
            </ul>
        `,
          acl: `
            <b>¿Qué es una ACL?</b><br>
            Es un firewall que controla el tráfico entrante/saliente hacia las subnets.<br><br>
            Nota: Las ACL son stateless, necesitan reglas de ida y vuelta.
        `,
        };

        document.getElementById("helpContent").innerHTML = helpText[section];
        new bootstrap.Modal(document.getElementById("helpModal")).show();
      }
    </script>

    <!-- Importar tu JS externo -->
    <script src="{{ url_for('VPC_controller_bp.static', filename='VPC_dashboard.js') }}"></script>
  </body>
</html>
